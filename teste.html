<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Pagamento via Pix</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
    /* Reset e Base */
    body { 
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
        background: #f5f5f5; /* Fundo cinza claro */
        margin: 0; 
        padding: 0;
        color: #333;
    }
    .container {
        max-width: 520px;
        margin: auto;
        padding: 0; /* Remove padding do container para que o card ocupe a largura total em mobile */
    }
    .card {
        background: white;
        padding: 25px;
        border-radius: 0; /* Remove border-radius para replicar o estilo de p√°gina inteira */
        box-shadow: none; /* Remove sombra para replicar o estilo de p√°gina inteira */
        margin-bottom: 0;
    }
    /* Estilo do Header (MM KDEFY GRUPOS LTDA) */
    .header-title {
        font-size: 16px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 0 20px 0;
        border-bottom: 1px solid #eee;
        margin-bottom: 20px;
    }
    .header-title span {
        background: #ddd;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: inline-flex;
        justify-content: center;
        align-items: center;
        font-size: 12px;
        font-weight: bold;
        color: #555;
    }
    /* Estilo do T√≠tulo Principal (Pague R$ 9,90) */
    h2 { 
        margin-top: 0; 
        font-size: 24px;
        font-weight: 600;
        color: #333;
    }
    .vencimento {
        color: #777;
        font-size: 14px;
        margin-bottom: 30px;
    }
    /* Estilo dos Inputs */
    .input { margin-bottom: 20px; }
    .input label { 
        font-weight: 500; 
        display: block; 
        margin-bottom: 5px; 
        font-size: 14px;
        color: #555;
    }
    .input input {
        width: 100%; 
        padding: 12px; 
        border: 1px solid #ccc; 
        border-radius: 8px; 
        font-size: 16px;
        box-sizing: border-box;
    }
    /* Estilo do Bot√£o */
    button {
        width: 100%;
        padding: 14px;
        background: #009ee3; /* Cor principal do Mercado Pago */
        border: none;
        color: white;
        font-size: 17px;
        font-weight: 600;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.3s;
    }
    button:hover {
        background: #007bb5;
    }
    /* Estilos P√≥s-Pagamento (QR Code) */
    .qr-section h3 {
        font-size: 18px;
        font-weight: 600;
        margin-top: 30px;
        margin-bottom: 15px;
    }
    .qr-code-box {
        text-align: center;
        margin: 20px 0;
    }
    .qr-code-box img {
        width: 100%;
        max-width: 200px;
        height: auto;
        border: 1px solid #eee;
        padding: 10px;
        border-radius: 8px;
    }
    .pix-code-label {
        font-size: 14px;
        color: #777;
        margin-top: 20px;
        margin-bottom: 5px;
    }
    .copy-field {
        width: 100%;
        padding: 12px;
        border: 1px solid #ccc;
        border-radius: 8px;
        background: #fafafa;
        font-size: 14px;
        white-space: nowrap;
        overflow-x: auto;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    .copy-field-text {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        flex-grow: 1;
    }
    .copy-icon {
        cursor: pointer;
        margin-left: 10px;
        color: #009ee3;
        font-weight: bold;
    }
    .copyBtn {
        background: #333;
        margin-top: 10px;
    }
    #cancelBtn { 
        background: #f44336; 
        margin-top: 10px; 
    }
    #cancelBtn.disabled { 
        background: #ccc; 
        cursor: not-allowed; 
    }
    #timer { 
        text-align: center; 
        margin-top: 15px; 
        color: #f44336; 
        font-size: 15px; 
        font-weight: 500;
    }
    /* Estilo das Instru√ß√µes (Como pagar?) */
    .instrucoes-title {
        font-size: 18px;
        font-weight: 600;
        margin-top: 30px;
        margin-bottom: 15px;
    }
    .instrucoes-number {
        display: flex;
        align-items: flex-start;
        gap: 15px;
        margin-top: 15px;
        font-size: 15px;
        line-height: 1.4;
    }
    .instrucoes-number span {
        background: #009ee3; /* Cor azul do Mercado Pago */
        color: white;
        width: 20px;
        min-width: 20px;
        height: 20px;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 12px;
        font-weight: bold;
        margin-top: 2px;
    }
    .pix-limit-info {
        font-size: 12px;
        color: #777;
        margin-top: 20px;
        padding-top: 15px;
        border-top: 1px solid #eee;
    }
    /* Detalhes da Compra */
    .detalhes-compra {
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid #eee;
    }
    .detalhes-compra-header {
        display: flex;
        align-items: center;
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 15px;
    }
    .detalhes-compra-header .icon {
        margin-right: 10px;
        color: #009ee3;
        font-size: 20px;
    }
    .detalhe-linha {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
        font-size: 15px;
        color: #555;
    }
    .detalhe-linha.total {
        font-weight: bold;
        color: #333;
        padding-top: 10px;
        border-top: 1px solid #eee;
        margin-top: 15px;
    }
    /* Footer (Contato) */
    .footer-box {
        background: white;
        padding: 20px 25px;
        margin-top: 20px;
        border-top: 1px solid #eee;
        display: flex;
        align-items: center;
        gap: 15px;
        font-size: 15px;
        color: #555;
    }
    .footer-box .icon {
        background: #e8f1ff;
        color: #009ee3;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 6px; /* Adiciona padding para centralizar o SVG 24x24 dentro do c√≠rculo 36x36 */
    }
    .footer-box a { 
        color: #009ee3; 
        font-weight: 500;
        text-decoration: none;
    }
    /* Responsividade */
    @media (min-width: 520px) {
        .container {
            padding: 20px;
        }
        .card {
            border-radius: 12px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
        }
        .footer-box {
            border-radius: 12px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
            margin-top: 10px;
            border-top: none;
        }
    }
</style>
</head>
<body>

<div class="container">

<div class="card" id="pre-checkout">
    <div class="header-title">
        <span>MM</span> 
        KDEFY GRUPOS LTDA
    </div>

    <h2>Pague R$ 9,90 via Pix</h2>
    <div class="vencimento">Vencimento: 5 minutos ap√≥s a gera√ß√£o</div>

    <div class="input">
        <label for="nome">Nome</label>
        <input id="nome" type="text">
    </div>

    <div class="input">
        <label for="cpf">CPF</label>
        <input id="cpf" type="text">
    </div>

    <div class="input">
        <label for="email">Email</label>
        <input id="email" type="email" value="kdefycom@gmail.com">
    </div>

    <button id="payBtn">Gerar pagamento PIX</button>

    <div id="timer"></div>
</div>

<div id="result" style="display: none;">
    <!-- Conte√∫do do QR Code ser√° injetado aqui -->
</div>

<div class="footer-box">
    <div class="icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg></div>
    <div>
        Se tiver algum inconveniente, entre em contato <br>
        <a href="mailto:kdefycom@gmail.com">kdefycom@gmail.com</a>
    </div>
</div>

</div>

<script>
let paymentId = null;
let countdown = 300;
let timerInterval = null;

function startTimer() {
    const timerElement = document.getElementById("timer");
    timerInterval = setInterval(async () => {
        countdown--;
        
        const minutes = Math.floor(countdown / 60);
        const seconds = countdown % 60;
        const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

        timerElement.innerText = `O pagamento expira em ${timeString}`;

        if (countdown <= 0) {
            clearInterval(timerInterval);
            timerElement.innerText = "Pagamento expirado.";

            const cancelBtn = document.getElementById("cancelBtn");
            if(cancelBtn && !cancelBtn.disabled){
                cancelBtn.classList.add("disabled");
                cancelBtn.disabled = true;

                if(paymentId){
                    // Simula√ß√£o de cancelamento
                    await fetch(`http://localhost:3000/cancelar/${paymentId}`, { method: "GET" });
                }
            }
        }
    }, 1000);
}

document.getElementById("payBtn").onclick = async () => {
    const nome = document.getElementById("nome").value;
    const cpf = document.getElementById("cpf").value;
    const email = document.getElementById("email").value;
    const total_amount = 9.90;

    if(!nome || !cpf || !email){
        alert("Preencha todos os campos!");
        return;
    }

    // Esconde o pr√©-checkout e mostra o resultado
    document.getElementById("pre-checkout").style.display = 'none';
    document.getElementById("result").style.display = 'block';

    // Simula√ß√£o de cria√ß√£o de pagamento
    const res = await fetch("http://localhost:3000/criar-pagamento", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ 
            name: nome, 
            email: email, 
            total_amount: total_amount,
            product_name: "grupo categoria paga",
            description: "Pagamento via PIX - KDEFY GRUPOS LTDA",
            document: cpf
        })
    });

    const data = await res.json();
    if(!data || !data.id){
        alert("Erro ao criar pagamento.");
        // Volta para o pr√©-checkout em caso de erro
        document.getElementById("pre-checkout").style.display = 'block';
        document.getElementById("result").style.display = 'none';
        return;
    }

    paymentId = data.id;

    const pixPayload = data.pix_payload || "00020126360014br.gov.bcb.pix011453727795000109520400005303986304000054069.905802BR5925KDEFY GRUPOS LTDA6007BRASIL62070503***6304D14F"; // Payload simulado
    const qrUrl = `http://localhost:3000/qr/${paymentId}`;

    document.getElementById("result").innerHTML = `
    <div class="card qr-section">
        <div class="header-title">
            <span>MM</span> 
            KDEFY GRUPOS LTDA
        </div>

        <h2>Pague R$ 9,90 via Pix</h2>
        <div class="vencimento" id="vencimento-qr">O pagamento expira em 05:00</div>

        <p style="font-weight: 500; margin-top: 30px;">Para pagar, escolha uma destas op√ß√µes:</p>
        
        <div class="qr-code-box">
            <p style="font-size: 14px; color: #555; margin-bottom: 5px;">C√≥digo QR</p>
            <img src="${qrUrl}" alt="QR Code Pix">
        </div>

        <div class="pix-code-label">C√≥digo de pagamento</div>
        <div class="copy-field">
            <div class="copy-field-text">${pixPayload}</div>
            <div class="copy-icon" onclick="copyPayload()">üìã</div>
        </div>

        <div class="instrucoes-title">Como pagar?</div>

        <div class="instrucoes-number">
            <span>1</span> <div>Entre no app ou site do seu banco e escolha a op√ß√£o de pagamento via Pix.</div>
        </div>

        <div class="instrucoes-number">
            <span>2</span> <div>Escaneie o c√≥digo QR ou copie e cole o c√≥digo de pagamento.</div>
        </div>

        <div class="instrucoes-number">
            <span>3</span> <div>Pronto! O pagamento ser√° creditado na hora e voc√™ receber√° um e-mail de confirma√ß√£o.</div>
        </div>
        
        <div class="pix-limit-info">
            O Pix tem um limite di√°rio de transfer√™ncias. Para mais informa√ß√µes, por favor, consulte seu banco.
        </div>

        <div class="detalhes-compra">
            <div class="detalhes-compra-header">
                <span class="icon">üßæ</span>
                Detalhes da sua compra
            </div>
            <div class="detalhe-linha">
                <span>grupo categoria paga</span>
                <span>R$ 9,90</span>
            </div>
            <div class="detalhe-linha total">
                <span>Total</span>
                <span>R$ 9,90</span>
            </div>
        </div>

        <button id="cancelBtn" onclick="cancelPayment()">Cancelar Pagamento</button>
    </div>
    `;

    // Atualiza o elemento do timer para o novo local
    document.getElementById("timer").remove();
    document.getElementById("vencimento-qr").id = "timer";
    
    countdown = 300;
    clearInterval(timerInterval);
    startTimer();
};

function copyPayload() {
    const text = document.querySelector(".copy-field-text").innerText;
    navigator.clipboard.writeText(text);
    alert("C√≥digo Pix copiado!");
}

async function cancelPayment() {
    if (!paymentId) return;
    const cancelBtn = document.getElementById("cancelBtn");

    if (!cancelBtn || cancelBtn.disabled) return;

    // Simula√ß√£o de cancelamento
    await fetch(`http://localhost:3000/cancelar/${paymentId}`, { method: "GET" });

    cancelBtn.innerText = "Pagamento Cancelado";
    cancelBtn.classList.add("disabled");
    cancelBtn.disabled = true;

    clearInterval(timerInterval);
    document.getElementById("timer").innerText = "Pagamento cancelado.";
}
</script>

</body>
</html>
