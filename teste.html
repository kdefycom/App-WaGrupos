<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Pagamento PIX - R$9,90</title>
<style>
body { font-family: Arial; max-width: 480px; margin: auto; padding: 20px; }
h2 { text-align: center; }
label { display: block; margin-top: 12px; font-weight: bold; }
input { width: 100%; padding: 10px; margin-top: 5px; font-size: 16px; }
button { width: 100%; padding: 14px; margin-top: 20px; border: none; cursor: pointer; font-size: 17px; }
#payBtn { background: #007bff; color: white; }
#cancelBtn { background: red; color: white; }
#cancelBtn.disabled { background: #666; cursor: not-allowed; }
#result { margin-top: 25px; text-align: center; }
#payloadBox { margin-top: 10px; padding: 10px; background: #f2f2f2; word-break: break-all; font-size: 14px; }
.copyBtn { background: #222; color: white; padding: 10px; width: 100%; margin-top: 10px; }
#timer { margin-top: 20px; font-size: 16px; color: red; text-align: center; }
#info { font-size: 13px; color: #555; margin-top: 15px; }
.selo-container { display: flex; justify-content: center; margin-top: 20px; gap: 15px; }
.selo { display: flex; flex-direction: column; align-items: center; font-size: 12px; color: #555; }
.selo svg { width: 40px; height: 40px; margin-bottom: 5px; }
.valor { font-size: 18px; font-weight: bold; margin-top: 10px; color: green; }
</style>
</head>
<body>

<h2>Pagamento PIX - R$ 9,90</h2>

<label>Nome</label>
<input id="nome">

<label>CPF</label>
<input id="cpf">

<label>Email</label>
<input id="email">

<button id="payBtn">Finalizar Compra</button>

<div id="result"></div>
<div id="timer"></div>

<div id="info">
Os dados são coletados apenas para segurança da transação e, se necessário, para efetuar um pedido de reembolso.
</div>

<div class="selo-container">
    <div class="selo">
        <svg viewBox="0 0 24 24" fill="green">
            <path d="M12 0C5.371 0 0 5.371 0 12s5.371 12 12 12 12-5.371 12-12S18.629 0 12 0zm-1.2 17.4l-5.4-5.4 1.68-1.68 3.72 3.72 7.92-7.92 1.68 1.68-9.6 9.6z"/>
        </svg>
        <div>Protegido</div>
    </div>
    <div class="selo">
        <svg viewBox="0 0 24 24" fill="#007bff">
            <path d="M12 0C5.371 0 0 5.371 0 12s5.371 12 12 12 12-5.371 12-12S18.629 0 12 0zm1 17h-2v-2h2v2zm0-4h-2V7h2v6z"/>
        </svg>
        <div>Segurança</div>
    </div>
</div>

<script>
let paymentId = null;
let countdown = 300; // 5 minutos
let timerInterval = null;

function startTimer() {
    timerInterval = setInterval(async () => {
        countdown--;
        document.getElementById("timer").innerText =
            "Pague em até " + countdown + " segundos. Após isso será cancelado automaticamente.";

        if (countdown <= 0) {
            clearInterval(timerInterval);
            document.getElementById("timer").innerText = "Pagamento expirado.";

            const cancelBtn = document.getElementById("cancelBtn");
            if(cancelBtn && !cancelBtn.disabled){
                cancelBtn.classList.add("disabled");
                cancelBtn.disabled = true;

                if(paymentId){
                    await fetch(`http://localhost:3000/cancelar/${paymentId}`, { method: "GET" });
                }
            }
        }
    }, 1000);
}

document.getElementById("payBtn").onclick = async () => {
    const nome = document.getElementById("nome").value;
    const cpf = document.getElementById("cpf").value;
    const email = document.getElementById("email").value;
    const total_amount = 9.90;

    if(!nome || !cpf || !email){
        alert("Preencha todos os campos!");
        return;
    }

    const res = await fetch("http://localhost:3000/criar-pagamento", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ 
            name: nome, 
            email: email, 
            total_amount: total_amount, 
            product_name: "Produto Premium", 
            description: "Pagamento de teste", 
            document: cpf
        })
    });

    const data = await res.json();
    if(!data || !data.id){
        alert("Erro ao criar pagamento.");
        return;
    }

    paymentId = data.id;
    const pixPayload = data.pix_payload || "Não disponível";

    const qrUrl = `http://localhost:3000/qr/${paymentId}`;

    document.getElementById("result").innerHTML = `
        <h3>QR Code</h3>
        <img src="${qrUrl}" width="260">
        <div class="valor">Valor: R$ 9,90</div>
        <div id="payloadBox">${pixPayload}</div>
        <button class="copyBtn" onclick="copyPayload()">Copiar Payload</button>
        <button id="cancelBtn" onclick="cancelPayment()">Cancelar Pagamento</button>
    `;

    countdown = 300;
    clearInterval(timerInterval);
    startTimer();
};

function copyPayload() {
    const text = document.getElementById("payloadBox").innerText;
    navigator.clipboard.writeText(text);
}

async function cancelPayment() {
    if (!paymentId) return;
    const cancelBtn = document.getElementById("cancelBtn");
    if (!cancelBtn || cancelBtn.disabled) return;

    await fetch(`http://localhost:3000/cancelar/${paymentId}`, { method: "GET" });

    cancelBtn.innerText = "Pagamento Cancelado";
    cancelBtn.classList.add("disabled");
    cancelBtn.disabled = true;

    clearInterval(timerInterval);
    document.getElementById("timer").innerText = "Pagamento cancelado.";
}
</script>

</body>
</html>
