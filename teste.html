<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Mini Checkout PIX</title>
</head>
<body>
  <h2>Teste de Pagamento PIX</h2>
  <form id="checkoutForm">
    <input type="text" name="name" placeholder="Nome" required><br>
    <input type="text" name="document" placeholder="CPF (somente números)" required><br>
    <input type="text" name="phone" placeholder="Telefone (+5511...)" required><br>
    <input type="email" name="email" placeholder="Email" required><br>
    <input type="text" name="product_name" placeholder="Produto" required><br>
    <input type="text" name="description" placeholder="Descrição" required><br>
    <input type="number" name="total_amount" placeholder="Valor (10)" required><br>
    <button type="submit">Gerar PIX</button>
  </form>

  <h3>QR Code</h3>
  <img id="qrcode" src="" alt="QR Code aparecerá aqui" />

  <script>
    const form = document.getElementById('checkoutForm')
    const qrImg = document.getElementById('qrcode')

    form.addEventListener('submit', async (e) => {
      e.preventDefault()

      const formData = new FormData(form)
      const body = Object.fromEntries(formData.entries())

      // Ajuste de total_amount para número
      body.total_amount = parseFloat(body.total_amount)

      try {
        const res = await fetch('http://localhost:8000/criar-pagamento', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': '23BBCE8145B2BFB9F407C265BD82A7498F19DD90371D53CD34743E12E9F300BE'
          },
          body: JSON.stringify(body)
        })

        const data = await res.json()
        if(data.pix_payload) {
          // Mostra o QR usando a rota /qr/:id
          qrImg.src = `http://localhost:8000/qr/${data.id}`
        } else {
          alert('Erro: Não retornou payload PIX')
        }

      } catch(err) {
        console.error(err)
        alert('Erro ao criar pagamento')
      }
    })
  </script>
</body>
</html>
