<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Meus Grupos - KDefy</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><defs><linearGradient id='grad' x1='0%' y1='0%' x2='0%' y2='100%'><stop offset='0%' style='stop-color:%2322C55E;stop-opacity:1'/><stop offset='100%' style='stop-color:%2316a34a;stop-opacity:1'/></linearGradient></defs><text x='50' y='78' font-size='80' font-family='-apple-system,BlinkMacSystemFont,sans-serif' font-weight='bold' text-anchor='middle' fill='url(%23grad)'>K</text></svg>">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-main: #000000;
      --bg-container: #1A1A1A;
      --bg-container-light: #222222;
      --text-primary: #FFFFFF;
      --text-secondary: #888888;
      --text-tertiary: #AAAAAA;
      --action-green: #22C55E;
      --action-red: #EF4444;
      --action-blue: #3b82f6;
      --border-color: #333333;
      --shadow-color: rgba(150, 150, 150, 0.1);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background-color: var(--bg-main);
      color: var(--text-primary);
    }
    .container { max-width: 900px; margin: 0 auto; padding: 0 15px; }

    /* --- Sidebar & Header --- */
    .sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0s 0.3s; }
    .sidebar-overlay.active { opacity: 1; visibility: visible; transition: opacity 0.3s; }
    .sidebar { position: fixed; top: 0; right: -280px; width: 280px; height: 100%; background: #111; border-left: 1px solid var(--border-color); box-shadow: -4px 0 15px rgba(0,0,0,0.2); z-index: 1001; transition: right 0.3s; padding: 20px; }
    .sidebar.active { right: 0; }
    .sidebar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
    .sidebar h3 { font-size: 20px; color: var(--action-green); }
    .close-sidebar { background: none; border: none; font-size: 28px; cursor: pointer; color: var(--text-secondary); }
    .sidebar a { display: flex; align-items: center; gap: 15px; padding: 12px; text-decoration: none; color: var(--text-primary); border-radius: 8px; font-weight: 500; margin-bottom: 8px; }
    .sidebar a:hover { background-color: var(--bg-container); }
    .sidebar svg { width: 20px; height: 20px; flex-shrink: 0; color: var(--text-secondary); }
    
    .main-header { background-color: var(--bg-main); padding: 20px 0; border-bottom: 1px solid var(--border-color); position: sticky; top: 0; z-index: 998; }
    .header-content { display: flex; justify-content: space-between; align-items: center; }
    .logo { font-size: 24px; font-weight: 900; color: var(--text-primary); text-decoration: none; }
    .nav-buttons { display: flex; align-items: center; gap: 12px; }
    .menu-toggle { background: none; border: 1px solid var(--border-color); width: 42px; height: 42px; border-radius: 8px; cursor: pointer; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 5px; padding: 10px; }
    .menu-toggle span { display: block; width: 22px; height: 2px; background: var(--text-primary); border-radius: 1px; }
    
    .btn { padding: 10px 22px; border-radius: 8px; border: 1px solid transparent; font-size: 14px; font-weight: 700; text-decoration: none; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px; text-transform: uppercase; }
    .btn-send { background-color: var(--action-green); color: var(--text-primary); }
    .btn-send:hover { background-color: #16a34a; }
    .btn-my-groups-active { background-color: var(--bg-container); color: var(--text-primary); border-color: var(--text-primary); }

    /* --- NOVAS CAIXAS DE INFO --- */
    .info-box { padding: 15px 20px; border-radius: 12px; margin-bottom: 30px; font-size: 15px; line-height: 1.6; display: flex; align-items: flex-start; gap: 15px; }
    .info-box strong { font-weight: 700; }
    .info-box a { color: var(--action-blue); text-decoration: none; font-weight: 700; }
    .info-box a:hover { text-decoration: underline; }
    .info-box .emoji { font-size: 20px; }
    .info-box.blue { background-color: rgba(59, 130, 246, 0.1); border-left: 4px solid var(--action-blue); color: #bfdbfe; }
    .info-box.gray { background-color: var(--bg-container-light); border-left: 4px solid var(--text-secondary); color: var(--text-tertiary); }

    /* --- CONTENT --- */
    .content-section { padding: 50px 0; }
    .content-section .container h1 { text-align: center; font-size: 36px; font-weight: 900; margin-bottom: 10px; }
    .content-section .container .page-description { text-align: center; color: var(--text-secondary); margin-bottom: 40px; font-size: 16px; }

    /* --- GRUPO CARD --- */
    .grupo-item { background-color: var(--bg-container); border-radius: 16px; padding: 25px; margin-bottom: 25px; box-shadow: 0 4px 12px var(--shadow-color); display: flex; flex-direction: column; align-items: center; transition: all 0.3s ease; position: relative; }
    .grupo-item:hover { transform: translateY(-5px); box-shadow: 0 8px 20px var(--shadow-color); }

    .card-actions { position: absolute; top: 15px; right: 15px; display: flex; gap: 8px; z-index: 10; }
    .icon-btn { background: rgba(0,0,0,0.3); border: 1px solid var(--border-color); width: 36px; height: 36px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
    .icon-btn svg { width: 18px; height: 18px; }
    .icon-btn.edit-btn { color: var(--text-tertiary); }
    .icon-btn.edit-btn:hover { background-color: var(--action-blue); color: white; }
    .icon-btn.remove-btn { color: var(--action-red); }
    .icon-btn.remove-btn:hover { background-color: var(--action-red); color: white; }
    
    .grupo-foto-container { width: 100%; aspect-ratio: 16 / 9; border-radius: 12px; overflow: hidden; margin-bottom: 20px; background-color: var(--bg-main); }
    .grupo-foto { width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s ease; }
    .grupo-item:hover .grupo-foto { transform: scale(1.05); }

    .grupo-info { text-align: center; width: 100%; }
    .grupo-titulo { font-size: 22px; font-weight: 700; margin-bottom: 8px; color: var(--text-primary); }
    .grupo-desc { color: var(--text-secondary); margin-bottom: 15px; line-height: 1.6; font-size: 15px; }
    .grupo-details { font-size: 13px; color: var(--text-tertiary); margin-bottom: 25px; text-transform: uppercase; }
    
    .card-footer-action { width: 100%; }
    .btn-large { width: 100%; padding: 16px 20px; font-size: 16px; font-weight: 700; border-radius: 12px; text-transform: uppercase; border: none; cursor: pointer; }
    .btn-impulsionar { background-color: var(--action-green); color: var(--text-primary); box-shadow: 0 4px 15px -5px var(--action-green); }
    .btn-impulsionar:hover { background-color: #16a34a; transform: translateY(-2px); }
    .boost-timer, .btn-large[disabled] { display: block; width: 100%; padding: 16px 20px; font-size: 16px; font-weight: 700; border-radius: 12px; background-color: var(--bg-container-light); color: var(--text-primary); text-align: center; cursor: not-allowed; }
    .btn-reprovado { background-color: var(--action-red) !important; color: white !important; }
    
    .empty { text-align: center; padding: 60px 20px; background-color: var(--bg-container); border-radius: 12px; }

    /* --- MODAL DE EDI√á√ÉO --- */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1002; display: none; align-items: center; justify-content: center; }
    .modal { background: var(--bg-container); padding: 30px; border-radius: 16px; width: 90%; max-width: 500px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid var(--border-color); }
    .modal h2 { margin-bottom: 20px; font-size: 22px; }
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; margin-bottom: 8px; font-size: 14px; color: var(--text-secondary); }
    .form-group input { width: 100%; background: var(--bg-main); border: 1px solid var(--border-color); color: var(--text-primary); padding: 12px; border-radius: 8px; font-size: 16px; }
    .modal-actions { display: flex; justify-content: flex-end; gap: 12px; margin-top: 30px; }
    .btn-cancel { background: var(--bg-container-light); color: var(--text-primary); }

    /* --- FOOTER --- */
    .main-footer { text-align: center; padding: 40px 0 20px 0; border-top: 1px solid var(--bg-container-light); margin-top: 50px; }
    .main-footer p { color: var(--text-secondary); font-size: 14px; }
  </style>
</head>
<body>

  <div class="sidebar-overlay" id="sidebarOverlay"></div>
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <h3>Menu</h3>
      <button class="close-sidebar" id="closeSidebar">&times;</button>
    </div>
    <a href="/"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>Home</a>
    <a href="/termos-uso/"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zM6 20V4h7v5h5v11H6z"/></svg>Termos de Uso</a>
    <a href="/politica-privacidade/"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/></svg>Pol√≠tica de Privacidade</a>
  </aside>

  <header class="main-header">
    <div class="container header-content">
      <a href="/" class="logo">MEUS GRUPOS</a>
      <div class="nav-buttons">
        <a href="/enviar-grupo/" class="btn btn-send">ENVIAR GRUPO</a>
        <button class="menu-toggle" id="menuToggle" aria-label="Abrir menu"><span></span><span></span><span></span></button>
      </div>
    </div>
  </header>

  <main class="content-section">
    <div class="container">
      <h1 style="margin-top: 20px;">Seja Bem-Vindo(a)</h1>
      <p class="page-description">Acompanhe o status e gerencie os grupos que voc√™ enviou.</p>

      <div class="info-box blue">
        <span class="emoji">‚ÑπÔ∏è</span>
        <div><strong>Aviso Importante:</strong> Todos os grupos s√£o analisados antes da publica√ß√£o. Certifique-se de que seu conte√∫do segue nossas diretrizes. Leia os <a href="/termos-uso/">Termos de Uso</a> para mais detalhes.</div>
      </div>

      <div id="gruposLista"></div>
    </div>
  </main>
  
  <footer class="main-footer">
    <div class="container">
        <div class="info-box gray">
            <span class="emoji">üí°</span>
            <div><strong>Dica:</strong> Se um grupo for removido, voc√™ pode envi√°-lo novamente, mas evite apagar e reenviar com frequ√™ncia. Para alterar o link ou a imagem, use o bot√£o de edi√ß√£o (‚úèÔ∏è) no card do seu grupo.</div>
        </div>
      <p>¬© 2025 Kdefy. Todos os direitos reservados.</p>
    </div>
  </footer>

  <!-- MODAL DE EDI√á√ÉO -->
<div class="modal-overlay" id="editModalOverlay">
  <div class="modal" id="editModal">
    <h2>Editar Grupo</h2>
    <input type="hidden" id="editGroupId">

    <div class="form-group">
      <label>Foto (URL ou Upload)</label>

      <!-- Preview 16:9 -->
      <div style="width:100%; aspect-ratio:16/9; background:#111; border-radius:8px; overflow:hidden; display:flex; align-items:center; justify-content:center;">
        <img id="editFotoPreview" style="width:100%; height:100%; object-fit:cover; display:none;">
      </div>

      <!-- Upload -->
      <input type="file" id="editFotoFile" accept="image/*" style="margin-top:10px;">

      <!-- URL -->
      <input type="url" id="editFotoUrl" placeholder="https://exemplo.com/imagem.png" style="margin-top:10px;">
    </div>

    <div class="form-group">
      <label for="editLink">Link do Grupo</label>
      <input type="url" id="editLink" placeholder="https://chat.whatsapp.com/...">
    </div>

    <div class="modal-actions">
      <button class="btn btn-cancel" id="cancelEdit">Cancelar</button>
      <button class="btn btn-send" id="saveEdit">Salvar Altera√ß√µes</button>
    </div>
  </div>
</div>

<script src="/app.js"></script>
<script>
  let meusGrupos = [];

  document.addEventListener('DOMContentLoaded', () => {
    setupSidebar();
    setupModal();
    carregarMeusGrupos();
    setupImagePreview();
  });

  function setupImagePreview() {
    const urlInput = document.getElementById("editFotoUrl");
    const fileInput = document.getElementById("editFotoFile");
    const preview = document.getElementById("editFotoPreview");

    urlInput.addEventListener("input", () => {
      if (urlInput.value.trim() !== "") {
        preview.src = urlInput.value;
        preview.style.display = "block";
      }
    });

    fileInput.addEventListener("change", () => {
      const file = fileInput.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = () => {
        preview.src = reader.result;
        preview.style.display = "block";
        urlInput.value = "";
      };
      reader.readAsDataURL(file);
    });
  }

  function setupSidebar() {
    const toggle = document.getElementById('menuToggle');
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebarOverlay');
    const closeBtn = document.getElementById('closeSidebar');
    if (!toggle || !sidebar || !overlay || !closeBtn) return;
    const openMenu = () => { sidebar.classList.add('active'); overlay.classList.add('active'); };
    const closeMenu = () => { sidebar.classList.remove('active'); overlay.classList.remove('active'); };
    toggle.addEventListener('click', openMenu);
    closeBtn.addEventListener('click', closeMenu);
    overlay.addEventListener('click', closeMenu);
  }

  function setupModal() {
    const overlay = document.getElementById('editModalOverlay');
    const cancelBtn = document.getElementById('cancelEdit');
    const saveBtn = document.getElementById('saveEdit');

    overlay.addEventListener('click', (e) => {
      if (e.target === overlay) fecharModalEdicao();
    });
    cancelBtn.addEventListener('click', fecharModalEdicao);
    saveBtn.addEventListener('click', salvarEdicao);
  }

  async function carregarMeusGrupos() {
    const lista = document.getElementById('gruposLista');
    lista.innerHTML = '<p style="text-align:center; color: var(--text-secondary);">Carregando seus grupos...</p>';
    try {
      const gruposLocais = await buscarGruposLocais();
      if (gruposLocais.length === 0) {
        lista.innerHTML = `<div class="empty">
            <p style="font-size: 60px;">üì≠</p>
            <h3 style="margin:10px 0; color:var(--text-primary);">Nenhum grupo enviado ainda</h3>
            <p style="color:var(--text-secondary);">Que tal enviar seu primeiro grupo agora?</p>
            <a href="/enviar-grupo/" class="btn btn-send" style="margin-top: 20px;">‚ûï Enviar Novo Grupo</a>
          </div>`;
        return;
      }
      const ids = gruposLocais.map(g => g.id);
      const gruposAPI = await supabaseFetch(`grupos?id=in.(${ids.join(',')})`);
      
      meusGrupos = gruposLocais.map(local => {
        const apiData = gruposAPI.find(g => g.id === local.id);
        return apiData ? { ...local, ...apiData } : local;
      });

      lista.innerHTML = meusGrupos
        .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
        .map(renderizarGrupo)
        .join('');

    } catch (error) {
      console.error('Erro:', error);
      lista.innerHTML = '<div class="empty"><h3 style="color:var(--text-primary);">Ocorreu um erro</h3><p style="color:var(--text-secondary);">N√£o foi poss√≠vel carregar. Tente recarregar a p√°gina.</p></div>';
    }
  }

  function renderizarGrupo(grupo) {
    let actionButtonHTML = '';
    if (grupo.aprovado) {
      if (podeImpulsionar(grupo)) {
        actionButtonHTML = `<button class="btn-large btn-impulsionar" onclick="impulsionar(event, '${grupo.id}')">üöÄ IMPULSIONAR</button>`;
      } else {
        actionButtonHTML = `<div class="boost-timer">‚è∞ PR√ìXIMO BOOST EM ${tempoRestante(grupo)}</div>`;
      }
    } else if (grupo.mensagem_admin && grupo.mensagem_admin.includes('reprovado')) {
       actionButtonHTML = `<button class="btn-large btn-reprovado" disabled>REPROVADO</button>`;
    } else {
      actionButtonHTML = `<button class="btn-large" disabled>EM AN√ÅLISE</button>`;
    }

    const editIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>`;
    const trashIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>`;

    return `
      <div class="grupo-item" id="grupo-${grupo.id}">
        <div class="card-actions">
           <button class="icon-btn edit-btn" onclick="editarGrupo('${grupo.id}')" title="Editar grupo">${editIcon}</button>
           <button class="icon-btn remove-btn" onclick="removerGrupo('${grupo.id}')" title="Remover grupo">${trashIcon}</button>
        </div>
        <div class="grupo-foto-container">
          <img src="${grupo.foto_url || 'https://via.placeholder.com/1600x900/1A1A1A/FFFFFF?text=Sem+Imagem'}" alt="Foto do grupo ${grupo.nome}" class="grupo-foto">
        </div>
        <div class="grupo-info">
          <div class="grupo-titulo">${grupo.nome}</div>
          <div class="grupo-desc">${grupo.descricao || 'Sem descri√ß√£o.'}</div>
          <div class="grupo-details">
            <strong>CATEGORIA:</strong> ${getCategoryName(grupo.categoria)} ‚Ä¢ <strong>TIPO:</strong> ${grupo.tipo}
          </div>
          <div class="card-footer-action">
            ${actionButtonHTML}
          </div>
        </div>
      </div>
    `;
  }

  function editarGrupo(id) {
    const grupo = meusGrupos.find(g => g.id === id);
    if (!grupo) return;

    document.getElementById('editGroupId').value = id;
    document.getElementById('editFotoUrl').value = grupo.foto_url || '';
    document.getElementById('editLink').value = grupo.link || '';

    const preview = document.getElementById('editFotoPreview');
    if (grupo.foto_url) {
      preview.src = grupo.foto_url;
      preview.style.display = "block";
    } else {
      preview.style.display = "none";
    }

    document.getElementById('editModalOverlay').style.display = 'flex';
  }

  function fecharModalEdicao() {
    document.getElementById('editModalOverlay').style.display = 'none';
  }

  async function salvarEdicao() {
    const id = document.getElementById('editGroupId').value;

    const url = document.getElementById('editFotoUrl').value.trim();
    const file = document.getElementById('editFotoFile').files[0];

    let foto_final = url;

    if (file) {
      const reader = new FileReader();
      foto_final = await new Promise(res => {
        reader.onload = () => res(reader.result);
        reader.readAsDataURL(file);
      });
    }

    const link = document.getElementById('editLink').value.trim();
    const saveBtn = document.getElementById('saveEdit');
    
    if (!id) return;

    const originalText = saveBtn.textContent;
    saveBtn.textContent = 'Salvando...';
    saveBtn.disabled = true;

    try {
      await supabaseFetch(`grupos?id=eq.${id}`, {
        method: 'PATCH',
        body: JSON.stringify({ 
          foto_url: foto_final, 
          link: link, 
          aprovado: false, 
          mensagem_admin: 'Grupo em rean√°lise ap√≥s edi√ß√£o.' 
        })
      });

      fecharModalEdicao();
      setTimeout(() => carregarMeusGrupos(), 500);

    } catch (error) {
      alert('Erro ao salvar as altera√ß√µes: ' + error.message);
    } finally {
      saveBtn.textContent = originalText;
      saveBtn.disabled = false;
    }
  }

  function getCategoryName(id) { if (typeof CATEGORIES === 'undefined' || !id) return 'Outros'; const category = CATEGORIES.find(cat => cat.id === id); return category ? category.name : id.charAt(0).toUpperCase() + id.slice(1).replace(/_/g, ' ');}
  function podeImpulsionar(grupo) { if (!grupo.ultimo_boost) return true; const duasHoras = 2 * 60 * 60 * 1000; return Date.now() - new Date(grupo.ultimo_boost).getTime() > duasHoras; }
  function tempoRestante(grupo) { if (!grupo.ultimo_boost) return '0min'; const duasHoras = 2 * 60 * 60 * 1000; const passado = Date.now() - new Date(grupo.ultimo_boost).getTime(); const restante = duasHoras - passado; const minutos = Math.ceil(restante / 60000); return `${minutos}min`; }
  async function impulsionar(event, id) { const button = event.target; button.disabled = true; button.textContent = 'IMPULSIONANDO...'; try { await supabaseFetch(`grupos?id=eq.${id}`, { method: 'PATCH', body: JSON.stringify({ ultimo_boost: new Date().toISOString() }) }); carregarMeusGrupos(); } catch (error) { alert('Erro ao impulsionar: ' + error.message); button.disabled = false; button.textContent = 'üöÄ IMPULSIONAR'; } }
  async function removerGrupo(id) { if (!confirm('Tem certeza que deseja apagar este grupo?')) return; try { await removerGrupoLocal(id); await supabaseFetch(`grupos?id=eq.${id}`, { method: 'DELETE' }); carregarMeusGrupos(); } catch (error) { alert('Erro ao remover: ' + error.message); } }
</script>
</body>
</html>
