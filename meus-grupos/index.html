<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Meus Grupos - KDefy</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 100 100\'><defs><linearGradient id=\'grad\' x1=\'0%\' y1=\'0%\' x2=\'0%\' y2=\'100%\'><stop offset=\'0%\' style=\'stop-color:%2322C55E;stop-opacity:1\'/><stop offset=\'100%\' style=\'stop-color:%2316a34a;stop-opacity:1\'/></linearGradient></defs><text x=\'50\' y=\'78\' font-size=\'80\' font-family=\'-apple-system,BlinkMacSystemFont,sans-serif\' font-weight=\'bold\' text-anchor=\'middle\' fill=\'url(%23grad)\'>K</text></svg>">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-main: #000000;
      --bg-container: #1A1A1A;
      --bg-container-light: #222222;
      --text-primary: #FFFFFF;
      --text-secondary: #888888;
      --text-tertiary: #AAAAAA;
      --action-green: #22C55E;
      --action-red: #EF4444;
      --action-blue: #3b82f6;
      --border-color: #333333;
      --shadow-color: rgba(150, 150, 150, 0.1);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: \'Inter\', -apple-system, BlinkMacSystemFont, \'Segoe UI\', sans-serif;
      background-color: var(--bg-main);
      color: var(--text-primary);
    }
    .container { max-width: 900px; margin: 0 auto; padding: 0 15px; }

    /* --- Sidebar & Header (Mantido) --- */
    .sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0s 0.3s; }
    .sidebar-overlay.active { opacity: 1; visibility: visible; transition: opacity 0.3s; }
    .sidebar { position: fixed; top: 0; right: -280px; width: 280px; height: 100%; background: #111; z-index: 1001; transition: right 0.3s; padding: 20px; }
    .sidebar.active { right: 0; }
    .sidebar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
    .sidebar h3 { font-size: 20px; color: var(--action-green); }
    .close-sidebar { background: none; border: none; font-size: 28px; cursor: pointer; color: var(--text-secondary); }
    .sidebar a { display: flex; align-items: center; gap: 15px; padding: 12px; text-decoration: none; color: var(--text-primary); border-radius: 8px; font-weight: 500; margin-bottom: 8px; }
    .sidebar a:hover { background-color: var(--bg-container); }
    .sidebar svg { width: 20px; height: 20px; flex-shrink: 0; color: var(--text-secondary); }
    .main-header { background-color: var(--bg-main); padding: 20px 0; border-bottom: 1px solid var(--border-color); position: sticky; top: 0; z-index: 998; }
    .header-content { display: flex; justify-content: space-between; align-items: center; }
    .logo { font-size: 24px; font-weight: 900; color: var(--text-primary); text-decoration: none; }
    .nav-buttons { display: flex; align-items: center; gap: 12px; }
    .menu-toggle { background: none; border: 1px solid var(--border-color); width: 42px; height: 42px; border-radius: 8px; cursor: pointer; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 5px; padding: 10px; }
    .menu-toggle span { display: block; width: 22px; height: 2px; background: var(--text-primary); border-radius: 1px; }
    .btn { padding: 10px 22px; border-radius: 8px; border: 1px solid transparent; font-size: 14px; font-weight: 700; text-decoration: none; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px; text-transform: uppercase; }
    .btn-send { background-color: var(--action-green); color: var(--text-primary); }
    .btn-cancel { background: var(--bg-container-light); color: var(--text-primary); }

    /* --- Caixas de Info (Mantido) --- */
    .info-box { padding: 15px 20px; border-radius: 12px; margin-bottom: 30px; font-size: 15px; line-height: 1.6; display: flex; align-items: flex-start; gap: 15px; }
    .info-box strong { font-weight: 700; }
    .info-box a { color: var(--action-blue); text-decoration: none; font-weight: 700; }
    .info-box a:hover { text-decoration: underline; }
    .info-box .emoji { font-size: 20px; }
    .info-box.blue { background-color: rgba(59, 130, 246, 0.1); border-left: 4px solid var(--action-blue); color: #bfdbfe; }
    .info-box.gray { background-color: var(--bg-container-light); border-left: 4px solid var(--text-secondary); color: var(--text-tertiary); }

    /* --- Conte√∫do (Mantido) --- */
    .content-section { padding: 50px 0; }
    .content-section .container h1 { text-align: center; font-size: 36px; font-weight: 900; margin-bottom: 10px; }
    .content-section .container .page-description { text-align: center; color: var(--text-secondary); margin-bottom: 40px; font-size: 16px; }

    /* --- GRUPO CARD (ATUALIZADO) --- */
    .grupo-item { background-color: var(--bg-container); border-radius: 16px; margin-bottom: 25px; box-shadow: 0 4px 12px var(--shadow-color); overflow: hidden; transition: all 0.3s ease; }
    .grupo-item:hover { transform: translateY(-5px); box-shadow: 0 8px 20px var(--shadow-color); }
    
    .card-header { display: flex; justify-content: flex-end; align-items: center; padding: 12px 20px 10px; gap: 8px; }
    .icon-btn { background: rgba(255,255,255,0.05); border: 1px solid var(--border-color); width: 36px; height: 36px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
    .icon-btn svg { width: 18px; height: 18px; }
    .icon-btn.edit-btn { color: var(--text-tertiary); }
    .icon-btn.edit-btn:hover { background-color: var(--action-blue); color: white; border-color: var(--action-blue); }
    .icon-btn.remove-btn { color: var(--action-red); }
    .icon-btn.remove-btn:hover { background-color: var(--action-red); color: white; border-color: var(--action-red); }
    
    .grupo-foto-container { width: 100%; aspect-ratio: 16 / 9; background-color: var(--bg-main); }
    .grupo-foto { width: 100%; height: 100%; object-fit: cover; }
    
    .grupo-info-wrapper { padding: 25px; text-align: center; }
    .grupo-titulo { font-size: 22px; font-weight: 700; margin-bottom: 8px; color: var(--text-primary); }
    .grupo-desc { color: var(--text-secondary); margin-bottom: 15px; line-height: 1.6; font-size: 15px; }
    .grupo-details { font-size: 13px; color: var(--text-tertiary); margin-bottom: 25px; text-transform: uppercase; }
    .card-footer-action { width: 100%; }
    .btn-large { width: 100%; padding: 16px 20px; font-size: 16px; font-weight: 700; border-radius: 12px; text-transform: uppercase; border: none; }
    .btn-impulsionar { background-color: var(--action-green); color: var(--text-primary); box-shadow: 0 4px 15px -5px var(--action-green); cursor: pointer; }
    .btn-impulsionar:hover:not(:disabled) { background-color: #16a34a; transform: translateY(-2px); }
    .boost-timer, .btn-large[disabled] { display: block; width: 100%; padding: 16px 20px; font-size: 16px; font-weight: 700; border-radius: 12px; background-color: var(--bg-container-light); color: var(--text-primary); text-align: center; cursor: not-allowed; }
    .btn-reprovado { background-color: var(--action-red) !important; color: white !important; }

    /* --- MODAL DE EDI√á√ÉO --- */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1002; display: none; align-items: center; justify-content: center; }
    .modal { background: var(--bg-container); padding: 30px; border-radius: 16px; width: 90%; max-width: 500px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid var(--border-color); }
    .modal h2 { margin-bottom: 20px; font-size: 22px; }
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; margin-bottom: 8px; font-size: 14px; color: var(--text-secondary); }
    .form-group input { width: 100%; background: var(--bg-main); border: 1px solid var(--border-color); color: var(--text-primary); padding: 12px; border-radius: 8px; font-size: 16px; }
    .modal-actions { display: flex; justify-content: flex-end; gap: 12px; margin-top: 30px; }
  </style>
</head>
<body>

  <div class="sidebar-overlay" id="sidebarOverlay"></div>
  <aside class="sidebar" id="sidebar">
    <!-- Conte√∫do do Sidebar (Mantido) -->
  </aside>

  <header class="main-header">
    <div class="container header-content">
      <a href="/" class="logo">MEUS GRUPOS</a>
      <div class="nav-buttons">
        <a href="/enviar-grupo/" class="btn btn-send">ENVIAR GRUPO</a>
        <button class="menu-toggle" id="menuToggle" aria-label="Abrir menu"><span></span><span></span><span></span></button>
      </div>
    </div>
  </header>

  <main class="content-section">
    <div class="container">
      <h1 style="margin-top: 20px;">Seja Bem-Vindo(a)</h1>
      <p class="page-description">Acompanhe o status e gerencie os grupos que voc√™ enviou.</p>
      <div class="info-box blue">
         <span class="emoji">‚ÑπÔ∏è</span>
        <div><strong>Aviso Importante:</strong> Todos os grupos s√£o analisados antes da publica√ß√£o. Certifique-se de que seu conte√∫do segue nossas diretrizes. Leia os <a href="/termos-uso/">Termos de Uso</a> para mais detalhes.</div>
      </div>
      <div id="gruposLista"></div>
    </div>
  </main>
  
  <footer class="main-footer">
    <div class="container">
        <div class="info-box gray">
             <span class="emoji">üí°</span>
            <div><strong>Dica:</strong> Se um grupo for removido, voc√™ pode envi√°-lo novamente, mas evite apagar e reenviar com frequ√™ncia. Para alterar o link ou a imagem, use o bot√£o de edi√ß√£o (‚úèÔ∏è) no card do seu grupo.</div>
        </div>
      <p>¬© 2025 Kdefy. Todos os direitos reservados.</p>
    </div>
  </footer>

  <!-- MODAL DE EDI√á√ÉO (NOVO) -->
  <div class="modal-overlay" id="editModalOverlay">
    <div class="modal" id="editModal">
      <h2>Editar Grupo</h2>
      <input type="hidden" id="editGroupId">
      <div class="form-group">
        <label for="editFotoUrl">URL da Foto</label>
        <input type="url" id="editFotoUrl" placeholder="https://exemplo.com/imagem.png">
      </div>
      <div class="form-group">
        <label for="editLink">Link do Grupo</label>
        <input type="url" id="editLink" placeholder="https://chat.whatsapp.com/...">
      </div>
      <div class="modal-actions">
        <button class="btn btn-cancel" id="cancelEdit">Cancelar</button>
        <button class="btn btn-send" id="saveEdit">Salvar Altera√ß√µes</button>
      </div>
    </div>
  </div>

  <script src="/app.js"></script>
  <script>
    let meusGrupos = []; // Armazena os grupos carregados

    document.addEventListener('DOMContentLoaded', () => {
      setupSidebar();
      carregarMeusGrupos();
      setupModal(); // Nova fun√ß√£o para o modal
    });

    function setupSidebar() {
      // L√≥gica do sidebar (Mantida)
    }

    // NOVA FUN√á√ÉO
    function setupModal() {
        const overlay = document.getElementById('editModalOverlay');
        const cancelBtn = document.getElementById('cancelEdit');
        const saveBtn = document.getElementById('saveEdit');

        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) fecharModalEdicao();
        });
        cancelBtn.addEventListener('click', fecharModalEdicao);
        saveBtn.addEventListener('click', salvarEdicao);
    }

    async function carregarMeusGrupos() {
      const lista = document.getElementById('gruposLista');
      lista.innerHTML = \`<p style="text-align:center; color: var(--text-secondary);">Carregando seus grupos...</p>\`;
      try {
        const gruposLocais = await buscarGruposLocais();
        if (gruposLocais.length === 0) {
          // L√≥gica de "nenhum grupo" (Mantida)
          return;
        }
        const ids = gruposLocais.map(g => g.id);
        // Usando o supabase client diretamente
        const { data, error } = await supabase.from('grupos').select('*').in('id', ids);
        if (error) throw error;
        
        // Atualiza o array global
        meusGrupos = gruposLocais.map(local => {
          const apiData = data.find(g => g.id === local.id);
          return apiData ? { ...local, ...apiData } : local;
        });

        lista.innerHTML = meusGrupos.sort((a, b) => new Date(b.created_at) - new Date(a.created_at)).map(renderizarGrupo).join('');
      } catch (error) {
        // L√≥gica de erro (Mantida)
      }
    }

    function renderizarGrupo(grupo) {
      // L√ìGICA DO BOT√ÉO DE A√á√ÉO (RESTAURADA)
      let actionButtonHTML = '';
      if (grupo.aprovado) {
        if (podeImpulsionar(grupo)) {
          actionButtonHTML = \`<button class="btn-large btn-impulsionar" onclick="impulsionar(event, '${grupo.id}')">üöÄ IMPULSIONAR</button>\`;
        } else {
          actionButtonHTML = \`<div class="boost-timer">‚è∞ PR√ìXIMO BOOST EM ${tempoRestante(grupo)}</div>\`;
        }
      } else if (grupo.mensagem_admin) {
        actionButtonHTML = \`<button class="btn-large btn-reprovado" disabled>REPROVADO</button>\`;
      } else {
        actionButtonHTML = \`<button class="btn-large" disabled>EM AN√ÅLISE</button>\`;
      }

      const editIcon = \`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>\`;
      const trashIcon = \`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>\`;

      // CARD HTML ATUALIZADO
      return \`
        <div class="grupo-item" id="grupo-${grupo.id}">
          <div class="card-header">
             <button class="icon-btn edit-btn" onclick="abrirModalEdicao('${grupo.id}')" title="Editar grupo">${editIcon}</button>
             <button class="icon-btn remove-btn" onclick="removerGrupo('${grupo.id}')" title="Remover grupo">${trashIcon}</button>
          </div>
          <div class="grupo-foto-container">
            <img src="${grupo.foto_url || 'https://via.placeholder.com/1600x900/1A1A1A/FFFFFF?text=Sem+Imagem'}" alt="Foto do grupo ${grupo.nome}" class="grupo-foto">
          </div>
          <div class="grupo-info-wrapper">
            <div class="grupo-titulo">${grupo.nome}</div>
            <div class="grupo-desc">${grupo.descricao || 'Sem descri√ß√£o.'}</div>
            <div class="grupo-details">
              <strong>CATEGORIA:</strong> ${getCategoryName(grupo.categoria)} &bull; <strong>TIPO:</strong> ${grupo.tipo}
            </div>
            <div class="card-footer-action">
              ${actionButtonHTML}
            </div>
          </div>
        </div>
      \`;
    }
    
    // --- L√ìGICA DO MODAL (NOVO) ---
    function abrirModalEdicao(id) {
        const grupo = meusGrupos.find(g => g.id === id);
        if (!grupo) {
          console.error("Grupo n√£o encontrado para edi√ß√£o");
          return;
        }

        document.getElementById('editGroupId').value = id;
        document.getElementById('editFotoUrl').value = grupo.foto_url || '';
        document.getElementById('editLink').value = grupo.link || '';

        document.getElementById('editModalOverlay').style.display = 'flex';
    }

    function fecharModalEdicao() {
        document.getElementById('editModalOverlay').style.display = 'none';
    }

    async function salvarEdicao() {
        const id = document.getElementById('editGroupId').value;
        const foto_url = document.getElementById('editFotoUrl').value.trim();
        const link = document.getElementById('editLink').value.trim();
        const saveBtn = document.getElementById('saveEdit');
        
        if (!id) return;

        const originalText = saveBtn.textContent;
        saveBtn.textContent = 'Salvando...';
        saveBtn.disabled = true;

        try {
            const { error } = await supabase
                .from('grupos')
                .update({ foto_url: foto_url, link: link, aprovado: false, mensagem_admin: 'Grupo em rean√°lise ap√≥s edi√ß√£o.' })
                .eq('id', id);

            if (error) throw error;

            fecharModalEdicao();
            await carregarMeusGrupos(); // Recarrega para mostrar as altera√ß√µes
        } catch (error) {
            alert('Erro ao salvar as altera√ß√µes: ' + error.message);
        } finally {
            saveBtn.textContent = originalText;
            saveBtn.disabled = false;
        }
    }

    // --- Fun√ß√µes Anteriores (Mantidas) ---
    function getCategoryName(id) { /* ...c√≥digo mantido... */ }
    function podeImpulsionar(grupo) { /* ...c√≥digo mantido... */ }
    function tempoRestante(grupo) { /* ...c√≥digo mantido... */ }
    async function impulsionar(event, id) { /* ...c√≥digo mantido... */ }
    async function removerGrupo(id) { /* ...c√≥digo mantido... */ }

  </script>
</body>
</html>